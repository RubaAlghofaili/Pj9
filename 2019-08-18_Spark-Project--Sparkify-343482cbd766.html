<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Spark Project: Sparkify</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Spark Project: Sparkify</h1>
</header>
<section data-field="subtitle" class="p-summary">
This is udacity’s capstone project, using spark to analyze user behavior data from music app Sparkify.
</section>
<section data-field="body" class="e-content">
<section name="49ec" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="d6a1" id="d6a1" class="graf graf--h3 graf--leading graf--title">Sparkify</h3><h3 name="3114" id="3114" class="graf graf--h3 graf-after--h3">Project Overview</h3><p name="9789" id="9789" class="graf graf--p graf-after--h3">Sparkify is a music app, this dataset contains two months of sparkify user behavior log. The log contains some basic information about the user as well as information about a single action. A user can contain many entries. In the data, a part of the user is churned, through the cancellation of the account behavior can be distinguished.</p><h3 name="7fbb" id="7fbb" class="graf graf--h3 graf-after--p">Problem Statement</h3><p name="504e" id="504e" class="graf graf--p graf-after--h3">The job of the project is to find the characteristics of churned users from the behavioral data of these users, and take measures to retain the potential lost users as early as possible.</p><p name="e957" id="e957" class="graf graf--p graf-after--p">The difficulty of the project is that the data handed to the model training should be one item for each person. While our data are behavioral data, we need to extract the user characteristics from the behavioral data, and then hand it to the model for training and get the results. These features will be generated from exploratory data analysis and feature engineering. In the case of poor results, the process may iterate many times until the model performs well.</p><h3 name="63b3" id="63b3" class="graf graf--h3 graf-after--p">Data Preprocessing</h3><p name="c270" id="c270" class="graf graf--p graf-after--h3">Behavioral data is different from the final training data, and we need to clean up some values that are not in our consideration. UserId and sessionId are keywords whose behavior is difficult to analyze if they are null, so the null value need to be removed.</p><p name="ba6d" id="ba6d" class="graf graf--p graf-after--p">There are some empty strings in the userId that may be actions of unregistered users from their browsing pages. These users are not related to this churn rate analysis, so they are also removed from the data set.</p><h3 name="eff2" id="eff2" class="graf graf--h3 graf-after--p">Metrics</h3><p name="c95d" id="c95d" class="graf graf--p graf-after--h3">Since churn users is only a small part of all users, the model’s ability to identify churn cannot be measured by the accuracy. So recall rate is an important indicator. On the other hand, accuracy is an important indicator of the cost of retaining customers. Due to the the above goals, F1 is used as the measurement standard for training and evaluation.</p><h3 name="9cd2" id="9cd2" class="graf graf--h3 graf-after--p">Exploratory Data Analysis</h3><p name="e533" id="e533" class="graf graf--p graf-after--h3">First I’ve sorted out the meaning of all the columns:</p><p name="8bcf" id="8bcf" class="graf graf--p graf-after--p">Artist: Composer</p><p name="1969" id="1969" class="graf graf--p graf-after--p">Auth: login status</p><p name="111c" id="111c" class="graf graf--p graf-after--p">firstName: first name</p><p name="68c9" id="68c9" class="graf graf--p graf-after--p">gender: gender</p><p name="26f4" id="26f4" class="graf graf--p graf-after--p">ItemInSession: operation sequence number of this session, from small to large according to time</p><p name="a0f3" id="a0f3" class="graf graf--p graf-after--p">lastName: surname</p><p name="051a" id="051a" class="graf graf--p graf-after--p">length: the length of the song</p><p name="7811" id="7811" class="graf graf--p graf-after--p">Level: whether the user is paid</p><p name="5241" id="5241" class="graf graf--p graf-after--p">location: the user location</p><p name="27fb" id="27fb" class="graf graf--p graf-after--p">method: method of getting web pages (put/get)</p><p name="4b4f" id="4b4f" class="graf graf--p graf-after--p">page: browse the page overview</p><p name="8828" id="8828" class="graf graf--p graf-after--p">registration: time stamp for registration point in time</p><p name="9948" id="9948" class="graf graf--p graf-after--p">sessionId: sessionId that should be used to determine a single login operation</p><p name="ef81" id="ef81" class="graf graf--p graf-after--p">song: song name</p><p name="2438" id="2438" class="graf graf--p graf-after--p">status: page return code (200/307/404)</p><p name="6bc1" id="6bc1" class="graf graf--p graf-after--p">ts: the timestamp of the log time</p><p name="daf4" id="daf4" class="graf graf--p graf-after--p">UserAgent: browse the client information</p><p name="a562" id="a562" class="graf graf--p graf-after--p">UserId: userId</p><p name="ca0f" id="ca0f" class="graf graf--p graf-after--p">I looked at all the page values, which recorded all the possible actions of the user. One things to confirm is Cancellation Confirmation, it means the churn users. And most of the rest of the operations are in the process of listening to the music. Downgrade related activities should also be very important for companies, but this Downgrade is not in our research range.</p><figure name="9719" id="9719" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 212px; max-height: 403px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 190.1%;"></div><img class="graf-image" data-image-id="1*A7N9W1O1BnTZ4g9m4IlaXQ.png" data-width="212" data-height="403" src="https://cdn-images-1.medium.com/max/800/1*A7N9W1O1BnTZ4g9m4IlaXQ.png"></div></figure><p name="aa35" id="aa35" class="graf graf--p graf-after--figure">I first converted the timestamp to standard time for my observation and analysis. At the same time, all data periods were observed between October 1, 2018 and December 1, 2018.</p><figure name="df83" id="df83" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 276px; max-height: 108px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 39.1%;"></div><img class="graf-image" data-image-id="1*z1eQ3FzytZLeJyY4_HV9nw.png" data-width="276" data-height="108" src="https://cdn-images-1.medium.com/max/800/1*z1eQ3FzytZLeJyY4_HV9nw.png"></div></figure><p name="adc9" id="adc9" class="graf graf--p graf-after--figure">I looked at the records of some of churn users. Free users often receive a Roll Advert, which can have an impact on the user. Downgrade pages are sent to subscribers regularly, which may also have an impact. However, a similar situation can be found when looking at non-lost user records, so the impact cannot be determined.</p><p name="c7be" id="c7be" class="graf graf--p graf-after--p">I then added the churn column to the dataset to mark churn users, so now I can observe the difference between what happens to churn users and what doesn’t.</p><p name="28a0" id="28a0" class="graf graf--p graf-after--p">The ratio of males to females is slightly different.</p><figure name="02bd" id="02bd" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 392px; max-height: 266px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 67.9%;"></div><img class="graf-image" data-image-id="1*CfUUP4bLeWyRscVjWk19dg.png" data-width="392" data-height="266" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*CfUUP4bLeWyRscVjWk19dg.png"></div></figure><p name="2188" id="2188" class="graf graf--p graf-after--figure">looking at the paid status of the churn users, it seems that the paid users account for a large proportion, and then we can add this feature to see if it helps the model.</p><figure name="bace" id="bace" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 386px; max-height: 266px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 68.89999999999999%;"></div><img class="graf-image" data-image-id="1*om65t7t162n7qd6ypSKoNA.png" data-width="386" data-height="266" src="https://cdn-images-1.medium.com/max/800/1*om65t7t162n7qd6ypSKoNA.png"></div></figure><p name="0765" id="0765" class="graf graf--p graf-after--figure">This is the frequency of each page, I used the number of operations per 100 to analyze. You can see that the churn users Roll Advert frequency was significantly higher than the non-churn users. In addition, the two operations of Cancel and Cancel Confirmation are used to distinguish the churn users, so these two data cannot be analyzed by the user model and need to be removed before training the model.</p><figure name="6559" id="6559" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 366px; max-height: 386px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 105.5%;"></div><img class="graf-image" data-image-id="1*9KHP6IfmMvpdt8au0rPE_A.png" data-width="366" data-height="386" src="https://cdn-images-1.medium.com/max/800/1*9KHP6IfmMvpdt8au0rPE_A.png"></div></figure><p name="bd9d" id="bd9d" class="graf graf--p graf-after--figure">The number of operations per session doesn’t seem to make much difference between the two groups.</p><figure name="b70f" id="b70f" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 399px; max-height: 266px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 66.7%;"></div><img class="graf-image" data-image-id="1*hSJsNElU4npP-zaKMAN5aw.png" data-width="399" data-height="266" src="https://cdn-images-1.medium.com/max/800/1*hSJsNElU4npP-zaKMAN5aw.png"></div></figure><p name="1364" id="1364" class="graf graf--p graf-after--figure">Finally, I checked the distribution of the two groups according to the time points of listening to the music. There were slight differences between the time and the week, and significant differences between the time points of the month. The difference in monthly time points may be due to the uniform distribution of user churn, resulting in fewer users at the end of the month.</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="d367" id="d367" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 476px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 46.1%;"></div><img class="graf-image" data-image-id="1*q99eto3GhKVx_lV6inohcg.png" data-width="1033" data-height="476" src="https://cdn-images-1.medium.com/max/1200/1*q99eto3GhKVx_lV6inohcg.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><h3 name="9aa6" id="9aa6" class="graf graf--h3 graf-after--figure">Feature Engineering</h3><p name="f25c" id="f25c" class="graf graf--p graf-after--h3">The selection of features is based in part on user characteristics, including gender, registration time, whether paid, and how many singers have been heard.</p><p name="ea17" id="ea17" class="graf graf--p graf-after--p">Some are based on behavioral data. The selection of behavioral data is mostly based on the session of each user, including the statistical value of listening time of each session, the number of listening songs in each session, and the number of sessions.</p><p name="a2ff" id="a2ff" class="graf graf--p graf-after--p">The final count is the number of pages per 100 views.I generated a dataframe for each feature separately, and finally made all features into a dataframe for the final training model by left linking.</p><h3 name="8713" id="8713" class="graf graf--h3 graf-after--p">Modeling</h3><p name="e395" id="e395" class="graf graf--p graf-after--h3">First, I confirmed the skew of data distribution. Data skew affects not only our metrics, but also our results, as we’ll see later.</p><figure name="8049" id="8049" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 119px; max-height: 105px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 88.2%;"></div><img class="graf-image" data-image-id="1*DGX65AOIJCWpzJJ5Ib9U4A.png" data-width="119" data-height="105" src="https://cdn-images-1.medium.com/max/800/1*DGX65AOIJCWpzJJ5Ib9U4A.png"></div></figure><p name="087a" id="087a" class="graf graf--p graf-after--figure">Then I saved the data. In the process of my many times of training, I thought that after restarting the kernel and re-reading the data, the speed of training would be significantly faster.</p><p name="00bf" id="00bf" class="graf graf--p graf-after--p">Before spark training the model, it was necessary to put all the features into vectors. When putting data into vectors, I found that many of my features were string types, so I have to convert them to float.</p><p name="83bc" id="83bc" class="graf graf--p graf-after--p">Although it does not affect the tree model, standardization is important for linear models. I decided to standardize the data.</p><p name="00bc" id="00bc" class="graf graf--p graf-after--p">I use linear model and tree model for training, including logistic model, decision tree and GBT. I select the model with the best performance, divide the test set using 3-fold cross validation and grid search to determine the model parameters for the training set. Finally I use the validation set to evaluate the model performance.</p><p name="4d28" id="4d28" class="graf graf--p graf-after--p">Logistic regression’s hyper-parameters includes elastic network parameters and regularization parameters. This is mainly based on the different regularization effects.</p><p name="04e7" id="04e7" class="graf graf--p graf-after--p">The detailed hyper-parameters are configured as follows:</p><figure name="6d4d" id="6d4d" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 637px; max-height: 102px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 16%;"></div><img class="graf-image" data-image-id="1*ZFzwXbR_Z9pSFP1MEeERlA.png" data-width="637" data-height="102" src="https://cdn-images-1.medium.com/max/800/1*ZFzwXbR_Z9pSFP1MEeERlA.png"></div></figure><p name="d435" id="d435" class="graf graf--p graf-after--figure">Decision tree’s hyper-parameters includes impurity and maximum depth. The maximum depth is for the overfitting case.</p><p name="e5e5" id="e5e5" class="graf graf--p graf-after--p">The detailed hyper-parameters are configured as follows:</p><figure name="82f1" id="82f1" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 101px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 14.499999999999998%;"></div><img class="graf-image" data-image-id="1*pR41skxoiEQxnHGj3rbzpA.png" data-width="718" data-height="104" src="https://cdn-images-1.medium.com/max/800/1*pR41skxoiEQxnHGj3rbzpA.png"></div></figure><p name="b100" id="b100" class="graf graf--p graf-after--figure">GBT’s hyper-parameters includes max iterations and maximum depth. They are all for the overfitting case.</p><p name="b9a1" id="b9a1" class="graf graf--p graf-after--p">The detailed hyper-parameters are configured as follows:</p><figure name="f0eb" id="f0eb" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 698px; max-height: 111px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 15.9%;"></div><img class="graf-image" data-image-id="1*3TDL0IDvSiSxi5hQF2Cerg.png" data-width="698" data-height="111" src="https://cdn-images-1.medium.com/max/800/1*3TDL0IDvSiSxi5hQF2Cerg.png"></div></figure><h3 name="bafb" id="bafb" class="graf graf--h3 graf-after--figure">Result</h3><p name="1e2e" id="1e2e" class="graf graf--p graf-after--h3">The result is not ideal, the recall rate of the model is very low, even the recall rate of the tree model is 0. I decided to undersample the training data, balance the categories of the training set to increase the recall rate and improve f1.</p><p name="cb7d" id="cb7d" class="graf graf--p graf-after--p">There is a strange problem here. Training results through cross-validation is good, but testing with validation sets is very poor. Logistic regression for example, the training result F1 score is 0.75, and the test result F1 score is 0.4. After the use of undersampling, the training result drops to 0.67, and the test result is 0.55.</p><figure name="c091" id="c091" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 530px; max-height: 128px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 24.2%;"></div><img class="graf-image" data-image-id="1*3mqZscXhiQMIU79yC1Qrlw.png" data-width="530" data-height="128" src="https://cdn-images-1.medium.com/max/800/1*3mqZscXhiQMIU79yC1Qrlw.png"></div></figure><p name="b65f" id="b65f" class="graf graf--p graf-after--figure">The best model is logistic regression. According to the results of the model, it is the frequency of Thumbs Down that has the greatest impact. Churn users have more Thumbs Down. Naturally, users will leave if they are not satisfied.</p><p name="7d77" id="7d77" class="graf graf--p graf-after--p graf--trailing">Besides, the frequency of downgrade pages is also a big factor. I think this is because users hate the downgrade prompt. Registration time is also a factor, the longer the registration time users will not leave.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@r1957.h" class="p-author h-card">Ruba Alghofaili</a> on <a href="https://medium.com/p/343482cbd766"><time class="dt-published" datetime="2019-08-18T18:51:49.441Z">August 18, 2019</time></a>.</p><p><a href="https://medium.com/@r1957.h/spark-project-sparkify-343482cbd766" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on August 18, 2019.</p></footer></article></body></html>